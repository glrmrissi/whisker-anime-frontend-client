<div class="comments-container">

    <div class="comment-form-section">
        <h2 class="section-title">Comments</h2>
        <form [formGroup]="commentForm" (ngSubmit)="submitComment()" class="comment-form">
            <textarea formControlName="content" placeholder="Share your thoughts..." class="comment-input"
                rows="4"></textarea>
            <div class="form-footer">
                <span class="char-count">{{ charCount }}/500</span>
                <button type="submit" class="submit-btn" [disabled]="commentForm.invalid || isSubmitting">
                    {{ isSubmitting ? 'Posting...' : 'Post Comment' }}
                </button>
            </div>
        </form>

        <div class="comments-list-section">
            @if (isLoading) {
            <div class="loading">Loading comments...</div>
            } @else {
            @if (comments.length > 0) {
            <div class="comments-list">
                @for (comment of comments; track comment.id) {
                <ng-container *ngTemplateOutlet="commentTree; context: { $implicit: comment, level: 0 }">
                </ng-container>
                }
            </div>
            } @else {
            <div class="no-comments">
                No comments yet. Be the first!
            </div>
            }
            }
        </div>
    </div>

    <ng-template #commentTree let-comment let-level="level">
        <div class="comment-item" [style.margin-left.px]="level > 0 ? 24 : 0">

            <div class="comment-header">
                <div class="user-avatar-container">
                    @if (comment.avatarUrl) {
                    <img [src]="baseUrl + comment.avatarUrl" class="user-avatar"
                        [class.small]="level > 0" alt="avatar">
                    } @else {
                    <div class="user-avatar default" [class.small]="level > 0">
                        {{ (comment.nickName || 'A').charAt(0) }}
                    </div>
                    }
                </div>

                <div class="user-details">
                    <span class="user-id">{{ comment.nickName || 'Anonymous' }}</span>
                    <small class="comment-date">{{ comment.createdAt | date: 'short' }}</small>
                </div>

                <div class="like-btn">
                    <p>{{ comment.likeCount }}</p>
                    <button (click)="likeTheComment(comment.id)" [class.liked]="comment.userLiked">
                        <fa-icon [icon]="faHeart"></fa-icon>
                    </button>
                </div>
            </div>

            <div class="comment-content">
                <p>{{ comment.content }}</p>
            </div>

            <div class="comment-footer">
                <button class="action-btn" (click)="setupReply(comment.id)">
                    {{ replyToId === comment.id ? 'Cancel' : 'Reply' }}
                </button>

                @if (comment.replyCount > 0) {
                <button class="action-btn replies-btn" (click)="toggleReplies(comment.id)">
                    <span>â†³ {{ comment.replyCount }} Replies</span>
                </button>
                }
            </div>

            @if (replyToId === comment.id) {
            <div class="reply-form-box">
                <form [formGroup]="commentForm" (ngSubmit)="submitComment()">
                    <textarea formControlName="content" placeholder="Write a reply..." class="comment-input"></textarea>
                    <div class="form-footer">
                        <span class="char-count">{{ charCount }}/500</span>
                        <button type="submit" class="submit-btn" [disabled]="commentForm.invalid || isSubmitting">
                            Post Reply
                        </button>
                    </div>
                </form>
            </div>
            }

            @if (expandedReplies[comment.id]) {
            <div class="replies-section">
                @if (comment.replies && comment.replies.length > 0) {
                @for (reply of comment.replies; track reply.id) {
                <ng-container *ngTemplateOutlet="commentTree; context: { $implicit: reply, level: level + 1 }">
                </ng-container>
                }
                } @else {
                <div class="loading-replies">Loading replies...</div>
                }
            </div>
            }
        </div>
    </ng-template>